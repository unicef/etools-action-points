<!--
App global configuration
-->
<!--import [polymer/polymer-element, etools-dexiejs, lodash]-->

<script>
    window.APDMixins = window.APDMixins || {};
    /**
     * @polymer
     * @mixinFunction
     */
    APDMixins.AppConfig = Polymer.dedupingMixin(baseClass => class extends baseClass {
        constructor() {
            super();

            let etoolsCustomDexieDb = new Dexie('APD');
            etoolsCustomDexieDb.version(1).stores({
                listsExpireMapTable: '&name, expire',
                partners: 'id'
            });
            window.EtoolsRequestCacheDb = etoolsCustomDexieDb;

            const endpoints = {
                userProfile: {
                    url: '/users/api/profile/'
                },
                changeCountry: {
                    url: '/users/api/changecountry/'
                },
                partnerOrganisations: {
                    url: '/api/v2/partners/?hidden=false',
                    exp: 2 * 60 * 60 * 1000, // 2h
                    cacheTableName: 'partners'
                },
                partnerOrganisationDetails: {
                    template: '/api/v2/partners/<%=id%>/'
                },
                interventionDetails: {
                    template: '/api/v2/interventions/<%=id%>/'
                },
                cpOutputsV2: {
                    template: '/api/v2/reports/results/?values=<%=ids%>'
                },
                actionPointsList: {
                    url: '/api/action-points/action-points/'
                },
                actionPoint: {
                    template: '/api/action-points/action-points/<%=id%>/'
                },
                actionPointComplete: {
                    template: '/api/action-points/action-points/<%=id%>/complete/'
                },
                locations: {
                    url: '/api/locations-light/',
                    exp: 90 * 24 * 3600 * 1000, // 3 months
                    cachingKey: 'locations'
                },
                sectionsCovered: {
                    url: '/api/sections/'
                },
                offices: {
                    url: '/api/offices/'
                },
                unicefUsers: {
                    url: '/api/users/'
                }
            };

            const localEndpoints = {
                userProfile: {
                    url: '/data/user-profile.json'
                },
                actionPotins: {
                    url: '/data/action-points.json'
                }
            };


            this.baseSite = window.location.origin;
            this.serverBackend = (window.location.port !== '8080');
            this.basePath = this.serverBackend ? '/apd/' : '/';
            this.epsData = this.serverBackend ? endpoints : localEndpoints;
            // dexie js
            this.appDexieDb = etoolsCustomDexieDb;

        }

        getEndpoint(endpointName, data) {
            let endpoint = this.epsData[endpointName];
            if (endpoint && endpoint.hasOwnProperty('template') && endpoint.template !== '') {
                endpoint.url = this.baseSite + _.template(endpoint.template)(data);
            }
            return _.clone(endpoint);
        }

        resetOldUserData() {
            console.log('resetOldUserData()');
            localStorage.removeItem('userId');
            this.appDexieDb.listsExpireMapTable.clear();
        }

        getAbsolutePath(path) {
            path = path || '';
            return this.basePath + path;
        }
    });
</script>
