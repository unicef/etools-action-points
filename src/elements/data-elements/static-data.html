<!--import [polymer/polymer-element, etools-ajax, lodash]-->
<!--import [static-data-mixin, permission-controller, user-controller, user-data, etools-app-config]-->

<dom-module id="static-data">
    <template>
        <user-data></user-data>
    </template>

    <script>
        const StaticDataMixins = EtoolsMixinFactory.combineMixins([
            APDMixins.AppConfig,
            EtoolsAjaxRequestMixin,
            APDMixins.StaticDataMixin,
            APDMixins.PermissionController,
            APDMixins.UserController], Polymer.Element);

        class StaticData extends StaticDataMixins {
            constructor() {
                super();
                this.dataLoaded = {};
            }

            static get is() {
                return 'static-data';
            }

            ready() {
                super.ready();
                this.shadowRoot.querySelector('user-data').addEventListener('user-profile-loaded', () => {
                    this.loadStaticData();
                });
            }

            loadStaticData() {
                this._loadAPOptions();
                this._loadPartners();
                this._loadLocations();
                this._loadData('sectionsCovered');
                this._loadData('offices');
                this._loadData('unicefUsers');
            }

            _allDataLoaded() {
                if (this.dataLoaded.organizations && this.dataLoaded.apOptions &&
                    this.dataLoaded.sectionsCovered && this.dataLoaded.offices && this.dataLoaded.unicefUsers) {
                    this.dispatchEvent(new CustomEvent('static-data-loaded', {bubbles: true, composed: true}));
                }
            }

            _loadAPOptions() {
                let endpoint = this.getEndpoint('actionPointsList');
                this.sendRequest({method: 'OPTIONS', endpoint})
                    .then((data) => {
                        let actions = data && data.actions;
                        if (!this.isValidCollection(actions)) {
                            this._responseError('partners options');
                            return;
                        }

                        this._addToCollection('action_points', actions);

                        let statusesData = this.getChoices('action_points.status');
                        if (!statusesData) {console.error('Can not load action points statuses data');}
                        this._setData('statuses', statusesData);

                        let modulesData = this.getChoices('action_points.module');
                        if (!modulesData) {console.error('Can not load action points modules data');}
                        this._setData('modules', modulesData);

                        this.dataLoaded.apOptions = true;
                        this._allDataLoaded();
                    }, error => this._responseError('Partners', 'request error'));
            }

            _loadPartners() {
                let endpoint = this.getEndpoint('partnerOrganisations');
                this.sendRequest({method: 'GET', endpoint})
                    .then((data) => {
                        let partnerOrganisations = _.sortBy(data, ['name']);
                        this._setData('partnerOrganisations', partnerOrganisations);
                        this.dataLoaded.organizations = true;
                        this._allDataLoaded();
                    }, error => this._responseError('Partners', 'request error'));
            }

            _loadLocations() {
                let endpoint = this.getEndpoint('locations');
                this.sendRequest({method: 'GET', endpoint})
                    .then((data) => {
                        let locations = _.sortBy(data, ['name']);
                        this._setData('locations', locations);

                        let locationsLoaded = new CustomEvent('locations-loaded');
                        document.dispatchEvent(locationsLoaded);
                    }, error => this._responseError('Locations', 'request error'));
            }

            _loadData(dataName) {
                let endpoint = this.getEndpoint(dataName);
                this.sendRequest({method: 'GET', endpoint})
                    .then((data) => {
                        this._setData(dataName, data);
                        this.dataLoaded[dataName] = true;
                        this._allDataLoaded();
                    }, error => this._responseError(dataName, 'request error'));
            }

            _triggerGlobalEvent(eventName, data) {
                let detail = {detail: data};
                let event = new CustomEvent(eventName, detail);
                document.dispatchEvent(event);
            }

            _responseError(message, type, eventType = 'error') {
                console[eventType](`Can not load initial data: ${message || '?'}. Reason: ${type || '?'}`);
            }
        }

        customElements.define(StaticData.is, StaticData);
    </script>
</dom-module>
