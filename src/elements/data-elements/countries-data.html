<!--import [polymer/polymer-element, etools-ajax]-->

<dom-module id="countries-data">
    <template>
        <etools-ajax
                id="ajax"
                endpoint="[[endpoint]]"
                on-success="_handleResponse"
                caching-storage="dexie">
        </etools-ajax>
    </template>

    <script>

        let _data = {};
        let _countryEls = [];

        let _setCountryData = function(data) {
            _data.countries = data || {};
            this.load(_data);
            _countryEls.forEach(function(el) {
                if (el !== this) { el.load(_data); }
            });
        };

        class CountriesData extends Polymer.Element {
            static get is() {
                return 'countries-data';
            }

            static get properties() {
                return {
                    countries: {
                        type: Array,
                        readOnly: true,
                        notify: true
                    }
                };
            }

            ready() {
                this.load(_data);
            }

            attached() {
                if (_countryEls.length === 0 && !_data.countries) {
                    this.endpoint = etoolsAppConfig.globals.getEndpoint('countries');
                }
                _countryEls.push(this);
            }

            detached() {
                _countryEls.splice(_countryEls.indexOf(this), 1);
            }

            load(data) {
                if (data.countries) {
                    this._setCountries(data.countries);
                }
            }

            _handleResponse(res) {
                _setCountryData.bind(this)(res.detail);
            }
        }
    </script>
</dom-module>
