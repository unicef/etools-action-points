<!--import [polymer, lodash, permission-controller]-->

<script>
    'use strict';

    window.APDMixins = window.APDMixins || {};
    /**
     * Mixin error handling
     * @param superClass
     * @constructor
     */
    window.APDMixins.ErrorHandlerMixin = superClass => class extends APDMixins.PermissionController(superClass) {
        refactorErrorObject(errorData) {
            if (!errorData) {return {};}

            if (!_.isObject(errorData)) {return errorData;}

            if (_.isArray(errorData)) {
                return _.isObject(errorData[0]) && !!errorData[0] ?
                    errorData.map(object => this.refactorErrorObject(object)) : errorData[0];
            } else {
                _.forOwn(errorData, (value, key) => {
                    errorData[key] = this.refactorErrorObject(value);
                });
                return errorData;
            }

        }

        _checkInvalid(value) {
            return !!value;
        }

        errorHandler(errorObject, permissionPath) {
            let errorMessages = this._getErrorMessages(errorObject, permissionPath);
            let nonFieldMessage = this._getNonFieldsMessage(errorObject);
            if (nonFieldMessage) {
                errorMessages.push(nonFieldMessage);
            }
            for (let message of errorMessages) {
                this.dispatchEvent(new CustomEvent('toast', {
                    detail: {text: message},
                    bubbles: true,
                    composed: true
                }));
            }
        }

        _getErrorMessages(errorObject, permissionPath) {
            let messages = [];
            if (!errorObject || !errorObject.response) {return messages;}
            _.each(errorObject.response, (errorMessage, incorrectField) => {
                let fieldLabel = this.getFieldAttribute(`${permissionPath}.${incorrectField}`, 'label');
                messages.push(`${fieldLabel}: ${errorMessage}`);
            });
            return messages;
        }

        _getNonFieldsMessage(errorObj) {
            if (!_.isObject(errorObj)) {return null;}

            let message = null;
            if (_.isArray(errorObj)) {
                for (let value of errorObj) {
                    let recursive = this._getNonFieldsMessage(value);
                    recursive && !message ? message = recursive : null;
                }
            } else {
                _.each(errorObj, (value, key) => {
                    if (key === 'non_field_errors') {
                        message = value;
                    } else {
                        let recursive = this._getNonFieldsMessage(value);
                        recursive && !message ? message = recursive : null;
                    }
                });
            }
            return message;
        }
    };
</script>
