<!--import [polymer]-->

<script>
    'use strict';

    window.APDMixins = window.APDMixins || {};
    /*
     * Mixin for fix max-rows in paper-textarea.
     * @polymer
     * @mixinFunction
     */
    window.APDMixins.TextareaMaxRowsMixin = superClass => class extends superClass {
        connectedCallback() {
            super.connectedCallback();
            Polymer.dom.flush();
            let paperTextareas = this.shadowRoot.querySelectorAll('paper-textarea') || [];

            paperTextareas.forEach((paperTextarea) => {
                this.setMaxHeight(paperTextarea);
            });
        }

        setMaxHeight(paperTextarea) {
            if (!paperTextarea) {return false;}

            let paperInputContainer = Polymer.dom(paperTextarea.root).querySelector('paper-input-container');
            let textareaAutogrow = Polymer.dom(paperInputContainer).querySelector('.paper-input-input');

            if (!textareaAutogrow) {return false;}

            let textareaAutogrowStyles = window.getComputedStyle(textareaAutogrow, null) || {};
            let maxRows = +paperTextarea.getAttribute('max-rows');

            if (!maxRows || maxRows <= 1) {return false;}

            Polymer.Async.microTask.run(() => {
                let lineHeight = textareaAutogrowStyles.lineHeight || '';
                let lineHeightPx = parseInt(lineHeight, 10);

                if (lineHeightPx) {
                    let maxHeight = maxRows * lineHeightPx;
                    textareaAutogrow.style.maxHeight = `${maxHeight}px`;
                }
                textareaAutogrow.textarea.style.overflow = 'auto';
            });
        }
    };
</script>
