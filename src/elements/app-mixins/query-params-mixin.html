<!--import [lodash]-->
<script>
    'use strict';
    window.APDMixins = window.APDMixins || {};
    window.APDMixins.QueryParamsMixin = (superClass) => class extends superClass {
        parseQueries() {
            let queriesOvj = {},
                    queries = this.getQueriesString()
                            .slice(1)
                            .split('&');

            if (queries[0] === '') return {};
            queries.forEach((query) => {
                let [key, value] = query.split('=');
                queriesOvj[key] = value || true;
            });

            return queriesOvj;
        }

        getLocationProperty(property) {
            return window && window.location && window.location[property] || '';
        }

        getQueriesString () {
            return this.getLocationProperty('search');
        }

        getPath() {
            let path = this.getLocationProperty('pathname');
            if (~path.indexOf('/apd')) { path = path.slice(4) }
            return path.slice(1);
        }
        updateQueries(newQueries, path, noNotify) {
            if (!_.isObject(newQueries)) { return false; }
            let keys = Object.keys(newQueries);

            if (!keys.length) { return false; }

            path = path && _.isString(path) ? path : this.getPath();
            let queries = this.parseQueries();

            keys.forEach((key) => {
                if (newQueries[key] === undefined || newQueries[key] === false) delete queries[key];
                else queries[key] = newQueries[key];
            });

            queries = Object.keys(queries).map((key) => {
                let value = typeof queries[key] ===  'boolean' ? '' : `=${queries[key]}`;
                return `${key}${value}`;
            });

            try {
                window.history.replaceState({}, '', `${path}?${queries.join('&')}`);
            } catch (err) {
                console.warn(err);
            }

            if (!noNotify) { this.dispatchEvent(new CustomEvent('location-changed', {bubbles: true, composed: true})); }
            return true;
        }

        clearQueries() {
            try {
                this.history.replaceState({}, '', this.getLocationProperty('pathname'));
            } catch (err) {
                console.warn(err);
            }
            this.dispatchEvent(new CustomEvent('location-changed', {bubbles: true, composed: true}));
        }
    };
</script>
